---


- name: bootstrap
  hosts: all
  become: yes
  gather_facts: false


  tasks:
    - name: include variables needed by provisioner scripts
      include_vars: vars.yml

    - name: install latest version of a series of packages
      package:
        name: "{{ item }}"
        state: latest
      with_items: "{{ basic_packages }}"

    - name: Set MySQL root password
      mysql_user: name=root host={{ item }} password={{ mysql_password }} state=present
      with_items:
        - "{{ ansible_hostname }}"
        - 127.0.0.1
        - ::1
        - localhost

    - name: Are root credentials for MySQL already there?
      stat: path=/root/.my.cnf
      register: mysql_config
      changed_when: mysql_config.stat.exists == False

    - name: Copy the root credentials as .my.cnf file
      template: 
        src: root.cnf
        dest: /root/.my.cnf
        owner: root
        mode: 0600
      when: mysql_config.stat.exists == False

    - name: Restart MySQL
      action: service name=mysql state=restarted enabled=true
      when: mysql_config.stat.exists == False

    - name: Easy_install pip
      easy_install:
        name: pip
        state: latest

    - name: pip install
      pip:
        name: "{{ item }}"
        state: latest
      with_items: "{{ pip_packages }}"

    - group:
       name: admin
       state: present

    - user:
       name: combine
       comment: "Combine User"
       groups: admin
       shell: /bin/bash
       password: "{{ combine_password | password_hash('sha512') }}"
       update_password: on_create


    - name: Is miniconda installed already
      stat: path=/opt/miniconda/bin/conda
      register: conda_package
      changed_when: conda_package.stat.exists == False

    - name: Download miniconda
      get_url:
        url=https://repo.continuum.io/miniconda/Miniconda2-4.3.21-Linux-x86_64.sh
        dest=/tmp/miniconda.sh
        mode=0755
      register: download_mc
      when: conda_package.stat.exists == False

    - name: Install miniconda
      shell: /tmp/miniconda.sh -b -p /opt/miniconda
      args:
        creates: /opt/miniconda
        executable: /bin/bash
      register: install_mc
      when: download_mc | success

    - name: Configure miniconda
      shell: |
        conda config --set always_yes yes
        conda config --add channels conda-forge
        conda create -n combine python=3.5
        source activate combine
      args:
        creates: /opt/miniconda/envs/combine
        executable: /bin/bash
      environment:
        PATH: /opt/miniconda/bin:$PATH
      register: configure_mc
      when: install_mc | success

    - name: Let combine user use conda commands
      lineinfile:
        path: /home/combine/.bashrc
        line: "export PATH=/opt/miniconda/bin:$PATH"
        state: present
